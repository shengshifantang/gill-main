# Layout Planner è®­ç»ƒç­–ç•¥ï¼šçº¯ Layout vs æ··åˆæ•°æ®

## ğŸ¤” ä½ çš„æ‹…å¿§

> "å¦‚æœè®­ç»ƒå…¨éƒ¨åªç”¨å¸¦æœ‰ layout å¸ƒå±€ä¿¡æ¯çš„æ•°æ®è®­ç»ƒï¼Œä¼šä¸ä¼šå¯¼è‡´æ¨¡å‹æ³›åŒ–èƒ½åŠ›ä¸è¶³ï¼Ÿæ¯”å¦‚å¦‚æœ caption ä¸­æ²¡æœ‰æ˜ç¡®çš„å®ä½“ä»¥åŠç›¸åº”çš„å¸ƒå±€ä¿¡æ¯ï¼Œä¼šè®© qwen è¾“å‡ºé”™è¯¯çš„ä¿¡æ¯ï¼Ÿ"

è¿™æ˜¯ä¸€ä¸ªéå¸¸å¥½çš„é—®é¢˜ï¼è®©æˆ‘ä»å¤šä¸ªè§’åº¦åˆ†æï¼š

## ğŸ“Š ä¸¤ç§è®­ç»ƒç­–ç•¥å¯¹æ¯”

### ç­–ç•¥ 1ï¼šçº¯ Layout æ•°æ®è®­ç»ƒï¼ˆå½“å‰æ–¹æ¡ˆï¼‰

**æ•°æ®ç»„æˆ**ï¼š
- 100% Layout æ•°æ®ï¼ˆ198,551 æ¡ï¼‰
- æ¯æ¡æ•°æ®éƒ½æœ‰æ˜ç¡®çš„å¯¹è±¡å’Œåæ ‡

**ä¼˜ç‚¹**ï¼š
- âœ… æ¨¡å‹ä¸“æ³¨å­¦ä¹ å¸ƒå±€è§„åˆ’ä»»åŠ¡
- âœ… æ ¼å¼æ­£ç¡®ç‡é«˜ï¼ˆä¸“ä¸€æ€§å¼ºï¼‰
- âœ… å¯¹æœ‰å¯¹è±¡çš„åœºæ™¯æ•ˆæœæœ€å¥½

**æ½œåœ¨é—®é¢˜**ï¼š
- âš ï¸ å¯èƒ½å¯¹"æ— å¯¹è±¡"åœºæ™¯è¿‡åº¦æ•æ„Ÿ
- âš ï¸ å¯èƒ½å¼ºè¡Œè¾“å‡ºå¯¹è±¡ï¼ˆå³ä½¿ caption ä¸­æ²¡æœ‰ï¼‰

### ç­–ç•¥ 2ï¼šæ··åˆæ•°æ®è®­ç»ƒ

**æ•°æ®ç»„æˆ**ï¼š
- 80% Layout æ•°æ® + 20% æ— å¯¹è±¡æ•°æ®
- æˆ– 70% Layout + 30% é€šç”¨æ•°æ®

**ä¼˜ç‚¹**ï¼š
- âœ… æ›´å¥½çš„æ³›åŒ–èƒ½åŠ›
- âœ… èƒ½æ­£ç¡®å¤„ç†"æ— å¯¹è±¡"åœºæ™¯
- âœ… ä¸ä¼šå¼ºè¡Œè¾“å‡ºä¸å­˜åœ¨çš„å¯¹è±¡

**æ½œåœ¨é—®é¢˜**ï¼š
- âš ï¸ æ ¼å¼æ­£ç¡®ç‡å¯èƒ½ç•¥ä½ï¼ˆä»»åŠ¡æ··æ‚ï¼‰
- âš ï¸ è®­ç»ƒæ—¶é—´æ›´é•¿

## ğŸ¯ å…³é”®é—®é¢˜ï¼šä½ çš„ç³»ç»Ÿæ¶æ„

æ ¹æ®ä½ çš„ä»£ç ï¼Œä½ çš„å›¾åƒç”Ÿæˆæµç¨‹æ˜¯ï¼š

```
ç”¨æˆ·è¾“å…¥ Caption
    â†“
Layout Planner (ç”Ÿæˆå¸ƒå±€)
    â†“
Spatial Adapter (æ³¨å…¥å¸ƒå±€ä¿¡æ¯)
    â†“
Kolors (ç”Ÿæˆå›¾åƒ)
```

### é‡è¦å‘ç°ï¼šä½ æœ‰ä¸¤ä¸ªè¾“å…¥æºï¼

åœ¨ Spatial Adapter ä¸­ï¼Œè¾“å…¥åŒ…æ‹¬ï¼š
1. **åŸå§‹ Caption**ï¼ˆæ–‡æœ¬æè¿°ï¼‰
2. **Layout ä¿¡æ¯**ï¼ˆå¯¹è±¡ + åæ ‡ï¼‰

è¿™æ„å‘³ç€ï¼š
- å¦‚æœ Layout Planner è¾“å‡ºä¸ºç©ºï¼ˆæ— å¯¹è±¡ï¼‰ï¼ŒSpatial Adapter ä»ç„¶æœ‰åŸå§‹ Caption
- Kolors å¯ä»¥æ ¹æ®çº¯æ–‡æœ¬ç”Ÿæˆå›¾åƒï¼ˆé€€åŒ–ä¸ºæ™®é€š T2Iï¼‰

## âœ… æˆ‘çš„å»ºè®®ï¼šçº¯ Layout è®­ç»ƒ + åå¤„ç†ä¿æŠ¤

### æ–¹æ¡ˆ Aï¼šçº¯ Layout è®­ç»ƒ + ç©ºè¾“å‡ºä¿æŠ¤ï¼ˆæ¨èï¼‰

**è®­ç»ƒ**ï¼š
```bash
# ä½¿ç”¨çº¯ Layout æ•°æ®è®­ç»ƒ
python scripts/generate_layout_training_data.py \
    --labeled /mnt/disk/lxh/gill_data/wukong_labeled.jsonl \
    --output data/layout_planner_train.jsonl \
    --min-objects 1
```

**æ¨ç†æ—¶ä¿æŠ¤**ï¼š
```python
def safe_generate_layout(planner, caption):
    """å®‰å…¨çš„å¸ƒå±€ç”Ÿæˆï¼Œå¸¦ç©ºè¾“å‡ºä¿æŠ¤"""
    result = planner.generate_layout(caption)
    objects = result['objects']
    
    # å¦‚æœ caption ä¸­æ²¡æœ‰æ˜ç¡®çš„å®ä½“è¯ï¼Œä¸”æ¨¡å‹è¾“å‡ºäº†å¯¹è±¡
    # è¿›è¡ŒäºŒæ¬¡éªŒè¯
    if objects:
        # ç®€å•çš„å®ä½“æ£€æµ‹
        import jieba.posseg as pseg
        nouns = [w for w, flag in pseg.cut(caption) if flag.startswith('n')]
        
        # å¦‚æœ caption ä¸­æ²¡æœ‰åè¯ï¼Œä½†æ¨¡å‹è¾“å‡ºäº†å¯¹è±¡
        if len(nouns) == 0:
            print(f"âš ï¸ Caption ä¸­æ— æ˜ç¡®å®ä½“ï¼Œå¿½ç•¥ Layout è¾“å‡º")
            return {"layout_text": "", "objects": []}
    
    return result
```

**ä¼˜ç‚¹**ï¼š
- âœ… æ¨¡å‹ä¸“æ³¨å­¦ä¹ å¸ƒå±€ï¼ˆæ•ˆæœæœ€å¥½ï¼‰
- âœ… æ¨ç†æ—¶æœ‰ä¿æŠ¤æœºåˆ¶ï¼ˆä¸ä¼šä¹±è¾“å‡ºï¼‰
- âœ… è®­ç»ƒç®€å•ï¼Œæ•ˆæœå¯æ§

### æ–¹æ¡ˆ Bï¼šæ··åˆæ•°æ®è®­ç»ƒï¼ˆæ›´ä¿å®ˆï¼‰

**è®­ç»ƒ**ï¼š
```bash
# ç”Ÿæˆæ··åˆæ•°æ®ï¼ˆ80% Layout + 20% æ— å¯¹è±¡ï¼‰
python scripts/prepare_mixed_training_data.py \
    --labeled /mnt/disk/lxh/gill_data/wukong_labeled.jsonl \
    --unlabeled /mnt/disk/lxh/gill_data/wukong_downloaded_500k_fixed.jsonl \
    --output data/layout_planner_mixed.jsonl \
    --layout-ratio 0.8 \
    --total-size 200000
```

**è®­ç»ƒæ•°æ®æ ¼å¼**ï¼š
```json
// Layout æ•°æ®ï¼ˆ80%ï¼‰
{"caption": "æ¡Œå­å·¦è¾¹æœ‰ä¸€åªçŒ«", "objects": [...], "has_layout": true}

// æ— å¯¹è±¡æ•°æ®ï¼ˆ20%ï¼‰
{"caption": "ç¾ä¸½çš„é£æ™¯", "objects": [], "has_layout": false}
```

**ä¼˜ç‚¹**ï¼š
- âœ… æ¨¡å‹å­¦ä¼š"ä½•æ—¶ä¸è¾“å‡ºå¯¹è±¡"
- âœ… æ³›åŒ–èƒ½åŠ›æ›´å¼º
- âœ… ä¸éœ€è¦æ¨ç†æ—¶ä¿æŠ¤

**ç¼ºç‚¹**ï¼š
- âš ï¸ æ ¼å¼æ­£ç¡®ç‡å¯èƒ½ç•¥ä½ï¼ˆéœ€è¦éªŒè¯ï¼‰

## ğŸ§ª å®éªŒå»ºè®®

### é˜¶æ®µ 1ï¼šå…ˆç”¨çº¯ Layout è®­ç»ƒï¼ˆå¿«é€ŸéªŒè¯ï¼‰

```bash
# 1. ç”Ÿæˆçº¯ Layout æ•°æ®
python scripts/generate_layout_training_data.py \
    --labeled /mnt/disk/lxh/gill_data/wukong_labeled.jsonl \
    --output data/layout_planner_train.jsonl

# 2. è®­ç»ƒ
CUDA_VISIBLE_DEVICES=2 python scripts/train_layout_planner.py \
    --layout-json data/layout_planner_train.jsonl \
    --val-json data/coco-cn/coco-cn_val.jsonl \
    --base-model ./model/qwen2.5-7B-Instruct \
    --output-dir ./checkpoints/layout_planner_pure \
    --epochs 3 \
    --use-format-metric

# 3. æµ‹è¯•è¾¹ç•Œæƒ…å†µ
python scripts/verify_layout.py \
    --base-model ./model/qwen2.5-7B-Instruct \
    --adapter-path ./checkpoints/layout_planner_pure/final \
    --device cuda:0
```

**æµ‹è¯•ç”¨ä¾‹**ï¼š
```python
test_cases = [
    "æ¡Œå­å·¦è¾¹æœ‰ä¸€åªçŒ«",           # æœ‰æ˜ç¡®å¯¹è±¡ âœ“
    "ç¾ä¸½çš„é£æ™¯",                 # æ— æ˜ç¡®å¯¹è±¡ ï¼Ÿ
    "è“å¤©ç™½äº‘",                   # æ— æ˜ç¡®å¯¹è±¡ ï¼Ÿ
    "ä¸€ä¸ªäººåœ¨è·‘æ­¥",               # æœ‰æ˜ç¡®å¯¹è±¡ âœ“
    "æŠ½è±¡çš„è‰ºæœ¯ä½œå“",             # æ— æ˜ç¡®å¯¹è±¡ ï¼Ÿ
]
```

### é˜¶æ®µ 2ï¼šå¦‚æœå‘ç°é—®é¢˜ï¼Œå†ç”¨æ··åˆæ•°æ®è®­ç»ƒ

å¦‚æœçº¯ Layout æ¨¡å‹åœ¨"æ— å¯¹è±¡"åœºæ™¯ä¸‹è¡¨ç°ä¸å¥½ï¼ˆå¼ºè¡Œè¾“å‡ºå¯¹è±¡ï¼‰ï¼Œå†è€ƒè™‘æ··åˆè®­ç»ƒã€‚

## ğŸ“ˆ æ•°æ®é…æ¯”å»ºè®®

å¦‚æœé€‰æ‹©æ··åˆè®­ç»ƒï¼Œæ¨èé…æ¯”ï¼š

| åœºæ™¯ | Layout æ•°æ® | æ— å¯¹è±¡æ•°æ® | è¯´æ˜ |
|------|-------------|------------|------|
| **ä¿å®ˆ** | 70% | 30% | æ›´å¼ºçš„æ³›åŒ–èƒ½åŠ› |
| **å¹³è¡¡** | 80% | 20% | æ¨èé…æ¯” |
| **æ¿€è¿›** | 90% | 10% | æ›´å¥½çš„å¸ƒå±€æ•ˆæœ |

## ğŸ’¡ æœ€ç»ˆå»ºè®®

### çŸ­æœŸï¼ˆæ¨èï¼‰ï¼šçº¯ Layout è®­ç»ƒ

**ç†ç”±**ï¼š
1. **ä½ çš„ç³»ç»Ÿæœ‰ä¸¤ä¸ªè¾“å…¥æº**ï¼šå³ä½¿ Layout ä¸ºç©ºï¼ŒSpatial Adapter ä»æœ‰åŸå§‹ Caption
2. **å¯ä»¥åå¤„ç†ä¿æŠ¤**ï¼šæ¨ç†æ—¶æ£€æµ‹ Caption ä¸­æ˜¯å¦æœ‰å®ä½“è¯
3. **æ•ˆæœä¼˜å…ˆ**ï¼šçº¯ Layout è®­ç»ƒçš„æ ¼å¼æ­£ç¡®ç‡å’Œåæ ‡å‡†ç¡®æ€§æœ€é«˜
4. **å¿«é€ŸéªŒè¯**ï¼šå…ˆçœ‹æ•ˆæœï¼Œæœ‰é—®é¢˜å†è°ƒæ•´

### é•¿æœŸï¼ˆå¯é€‰ï¼‰ï¼šæ··åˆè®­ç»ƒ

å¦‚æœåœ¨å®é™…ä½¿ç”¨ä¸­å‘ç°ï¼š
- æ¨¡å‹å¯¹"æ— å¯¹è±¡"åœºæ™¯å¤„ç†ä¸å¥½
- ç»å¸¸å¼ºè¡Œè¾“å‡ºä¸å­˜åœ¨çš„å¯¹è±¡
- éœ€è¦æ›´å¼ºçš„æ³›åŒ–èƒ½åŠ›

å†è€ƒè™‘æ··åˆè®­ç»ƒï¼ˆ80% Layout + 20% æ— å¯¹è±¡ï¼‰ã€‚

## ğŸ”§ å®ç°ï¼šå®‰å…¨çš„æ¨ç†åŒ…è£…

åˆ›å»ºä¸€ä¸ªå®‰å…¨çš„æ¨ç†å‡½æ•°ï¼š

```python
def safe_layout_generation(planner, caption, min_nouns=1):
    """
    å®‰å…¨çš„å¸ƒå±€ç”Ÿæˆï¼Œå¸¦å®ä½“æ£€æµ‹
    
    Args:
        planner: LayoutPlanner å®ä¾‹
        caption: è¾“å…¥æ–‡æœ¬
        min_nouns: æœ€å°‘åè¯æ•°ï¼ˆä½äºæ­¤å€¼åˆ™ä¸è¾“å‡ºå¸ƒå±€ï¼‰
    """
    import jieba.posseg as pseg
    
    # 1. ç”Ÿæˆå¸ƒå±€
    result = planner.generate_layout(caption)
    
    # 2. æ£€æµ‹ caption ä¸­çš„åè¯
    nouns = [w for w, flag in pseg.cut(caption) if flag.startswith('n')]
    
    # 3. å¦‚æœåè¯å¤ªå°‘ï¼Œæ¸…ç©ºå¸ƒå±€è¾“å‡º
    if len(nouns) < min_nouns and result['objects']:
        print(f"âš ï¸ Caption ä¸­åè¯æ•° ({len(nouns)}) < {min_nouns}ï¼Œæ¸…ç©ºå¸ƒå±€è¾“å‡º")
        return {"layout_text": "", "objects": []}
    
    return result
```

## ğŸ“ æ€»ç»“

| æ–¹æ¡ˆ | è®­ç»ƒæ•°æ® | æ ¼å¼æ­£ç¡®ç‡ | æ³›åŒ–èƒ½åŠ› | æ¨èåº¦ |
|------|----------|------------|----------|--------|
| **çº¯ Layout** | 198,551 æ¡ | â­â­â­â­â­ | â­â­â­ | â­â­â­â­â­ |
| **çº¯ Layout + åå¤„ç†** | 198,551 æ¡ | â­â­â­â­â­ | â­â­â­â­ | â­â­â­â­â­ |
| **æ··åˆè®­ç»ƒ (80/20)** | 200,000 æ¡ | â­â­â­â­ | â­â­â­â­â­ | â­â­â­â­ |

**æˆ‘çš„å»ºè®®**ï¼šå…ˆç”¨çº¯ Layout è®­ç»ƒ + æ¨ç†æ—¶åå¤„ç†ä¿æŠ¤ï¼Œè¿™æ˜¯æœ€å¿«ä¸”æ•ˆæœæœ€å¥½çš„æ–¹æ¡ˆã€‚
