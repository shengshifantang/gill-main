# Spatial Adapter è®­ç»ƒè®¡åˆ’

## ğŸ“‹ è®­ç»ƒæ–¹æ¡ˆ

### å½“å‰çŠ¶æ€
- âœ… dtype ä¿®å¤å·²å®Œæˆï¼ˆAdapter/Phrase Embeddings ç»Ÿä¸€ FP16ï¼‰
- âœ… Zero Initialization å·²éªŒè¯
- âœ… è®­ç»ƒå·²å¯åŠ¨ï¼ŒLoss æ­£å¸¸ä¸‹é™ï¼ˆ0.0388 â†’ 0.0286ï¼‰
- ğŸ”„ å½“å‰æ­£åœ¨è¿è¡Œåˆæ­¥éªŒè¯ï¼ˆç›®æ ‡ 2000 æ­¥ï¼‰

---

## ğŸ¯ å®Œæ•´è®­ç»ƒè®¡åˆ’

### é˜¶æ®µ 1ï¼šåˆæ­¥éªŒè¯ âœ… è¿›è¡Œä¸­
**ç›®æ ‡**: éªŒè¯ä¿®å¤æœ‰æ•ˆæ€§
- **æ­¥æ•°**: 2000 æ­¥
- **æ—¶é—´**: ~1.5 å°æ—¶
- **æ£€æŸ¥ç‚¹**: `checkpoint-2000.pt`
- **éªŒè¯å†…å®¹**:
  - Loss æ˜¯å¦æ­£å¸¸ä¸‹é™
  - æ˜¯å¦å‡ºç° NaN
  - Gate åˆå§‹è¡Œä¸º

### é˜¶æ®µ 2ï¼šå®Œæ•´è®­ç»ƒ
**ç›®æ ‡**: è®­ç»ƒåˆ°æ”¶æ•›ï¼Œè§‚å¯Ÿ Gate Sudden Convergence
- **æ­¥æ•°**: 25000 æ­¥ï¼ˆçº¦ 0.6 epochï¼‰
- **æ—¶é—´**: ~18-20 å°æ—¶
- **æ£€æŸ¥ç‚¹**: æ¯ 2000 æ­¥ä¿å­˜
- **ç›‘æ§æŒ‡æ ‡**:
  - Loss æ›²çº¿ï¼ˆç›®æ ‡: 0.02-0.03ï¼‰
  - Gate ç»Ÿè®¡ï¼ˆæœŸæœ›: 0 â†’ 0.3-0.5ï¼‰
  - ç”Ÿæˆè´¨é‡

### é˜¶æ®µ 3ï¼šè¯„ä¼°ä¸ä¼˜åŒ–
**ç›®æ ‡**: è¯„ä¼°æ•ˆæœï¼Œå†³å®šæ˜¯å¦éœ€è¦è°ƒæ•´
- å¯¹æ¯”ä¸åŒ Gate å€¼çš„ç”Ÿæˆæ•ˆæœ
- å¦‚æœ Gate Collapse â†’ æ·»åŠ  RMSNorm
- å¦‚æœæ•ˆæœå¥½ â†’ ç»§ç»­è®­ç»ƒåˆ° 1 epoch

---

## ğŸš€ è®­ç»ƒè„šæœ¬ä½¿ç”¨æŒ‡å—

### 1. å®Œæ•´è®­ç»ƒï¼ˆä»å¤´å¼€å§‹ï¼‰
```bash
# åœæ­¢å½“å‰çš„ç®€åŒ–è®­ç»ƒ
# Ctrl+C åœæ­¢å½“å‰è¿›ç¨‹

# å¯åŠ¨å®Œæ•´è®­ç»ƒ
bash scripts/train_full.sh
```

**ç‰¹ç‚¹**:
- å®Œæ•´çš„è®­ç»ƒé…ç½®
- è‡ªåŠ¨ä¿å­˜è®­ç»ƒæ—¥å¿—
- æ¯ 2000 æ­¥ä¿å­˜ checkpoint

### 2. æ¢å¤è®­ç»ƒï¼ˆä» checkpoint ç»§ç»­ï¼‰
```bash
# å¦‚æœè®­ç»ƒä¸­æ–­ï¼Œä½¿ç”¨æ­¤è„šæœ¬æ¢å¤
bash scripts/train_resume.sh
```

**ç‰¹ç‚¹**:
- è‡ªåŠ¨æŸ¥æ‰¾æœ€æ–°çš„ checkpoint
- ä»ä¸­æ–­ç‚¹ç»§ç»­è®­ç»ƒ
- ä¿æŒè®­ç»ƒå‚æ•°ä¸€è‡´

### 3. æµ‹è¯• Checkpoint
```bash
# æµ‹è¯•æœ€æ–°çš„ checkpoint æ•ˆæœ
bash scripts/test_checkpoint.sh
```

**åŠŸèƒ½**:
- è‡ªåŠ¨åŠ è½½æœ€æ–° checkpoint
- ç”Ÿæˆ 10 ä¸ªæµ‹è¯•æ ·æœ¬
- æ˜¾ç¤º Gate ç»Ÿè®¡ä¿¡æ¯
- ä¿å­˜åˆ° `outputs/checkpoint_test_stepXXXX/`

### 4. ç›‘æ§è®­ç»ƒè¿›åº¦
```bash
# æŸ¥çœ‹è®­ç»ƒçŠ¶æ€
bash scripts/monitor_training.sh

# å®æ—¶æŸ¥çœ‹æ—¥å¿—
tail -f ./checkpoints/spatial_adapter_fp16_fixed/train.log
```

---

## ğŸ“Š å…³é”®ç›‘æ§æŒ‡æ ‡

### 1. Loss æ›²çº¿
**æ­£å¸¸èŒƒå›´**: 0.02 - 0.03
**å½“å‰å€¼**: 0.0286 âœ…

```
æ­¥æ•°     | ç›®æ ‡ Loss
---------|----------
2000     | 0.025-0.030
5000     | 0.020-0.025
10000    | 0.018-0.023
25000    | 0.015-0.020
```

### 2. Gate ç»Ÿè®¡ â­ æœ€é‡è¦
**æœŸæœ›è¡Œä¸º**:
```
æ­¥æ•°     | Gate Mean | çŠ¶æ€
---------|-----------|------
0-1000   | ~0.00     | åˆå§‹åŒ–ï¼ˆZero Initï¼‰
1000-5000| 0.00-0.10 | ç¼“æ…¢å¢é•¿
5000-15000| çªç„¶è·³è·ƒ  | Sudden Convergence
15000+   | 0.30-0.50 | ç¨³å®šæ”¶æ•›
```

**å¼‚å¸¸æƒ…å†µ**:
- Gate ä¸€ç›´ä¿æŒ 0 â†’ Gate Collapseï¼ˆéœ€è¦æ·»åŠ  RMSNormï¼‰
- Gate è¶…è¿‡ 1.0 â†’ è¿‡åº¦æ¿€æ´»ï¼ˆéœ€è¦é™ä½å­¦ä¹ ç‡ï¼‰

### 3. ç”Ÿæˆè´¨é‡
**æµ‹è¯•æ–¹æ³•**:
```bash
# æ¯ 2000 æ­¥æµ‹è¯•ä¸€æ¬¡
bash scripts/test_checkpoint.sh

# å¯¹æ¯”ä¸åŒ Gate å€¼
bash scripts/test_gate_effect_single_gpu.sh
```

---

## ğŸ”§ è®­ç»ƒå‚æ•°è¯´æ˜

| å‚æ•° | å€¼ | è¯´æ˜ |
|------|-----|------|
| `batch_size` | 2 | å•å¡æœ€ä¼˜é…ç½® |
| `lr` | 1e-4 | æ ‡å‡†å­¦ä¹ ç‡ |
| `phrase_dropout` | 0.1 | 10% æ¦‚ç‡ä¸¢å¼ƒæ–‡æœ¬ï¼Œå¢å¼ºé²æ£’æ€§ |
| `scale_min/max` | 0.5-1.0 | Adapter æ³¨å…¥å¼ºåº¦èŒƒå›´ |
| `save_every` | 2000 | ä¿å­˜é—´éš” |

---

## ğŸ“ è¾“å‡ºæ–‡ä»¶ç»“æ„

```
checkpoints/spatial_adapter_fp16_fixed/
â”œâ”€â”€ train_config.txt          # è®­ç»ƒé…ç½®
â”œâ”€â”€ train.log                 # è®­ç»ƒæ—¥å¿—
â”œâ”€â”€ checkpoint-2000.pt        # Checkpoint (2000æ­¥)
â”œâ”€â”€ checkpoint-4000.pt        # Checkpoint (4000æ­¥)
â”œâ”€â”€ ...
â””â”€â”€ final.pt                  # æœ€ç»ˆæ¨¡å‹

outputs/
â”œâ”€â”€ checkpoint_test_step2000/ # æµ‹è¯•ç»“æœ
â”œâ”€â”€ checkpoint_test_step4000/
â””â”€â”€ ...
```

---

## âš ï¸ æ³¨æ„äº‹é¡¹

### 1. å½“å‰è®­ç»ƒå¤„ç†
**é€‰é¡¹ A**: è®©å½“å‰è®­ç»ƒç»§ç»­åˆ° 2000 æ­¥
```bash
# ä¸åšä»»ä½•æ“ä½œï¼Œç­‰å¾…åˆ° 2000 æ­¥
# ç„¶åæµ‹è¯• checkpoint
bash scripts/test_checkpoint.sh
```

**é€‰é¡¹ B**: åœæ­¢å½“å‰è®­ç»ƒï¼Œå¯åŠ¨å®Œæ•´è®­ç»ƒ
```bash
# Ctrl+C åœæ­¢å½“å‰è¿›ç¨‹
# å¯åŠ¨å®Œæ•´è®­ç»ƒ
bash scripts/train_full.sh
```

**æ¨è**: é€‰é¡¹ Aï¼ˆè®©å½“å‰è®­ç»ƒå®Œæˆ 2000 æ­¥ï¼‰

### 2. æ˜¾å­˜ç®¡ç†
- å•å¡è®­ç»ƒå ç”¨çº¦ 20GB
- å¦‚æœ OOMï¼Œé™ä½ `batch_size` åˆ° 1
- VAE å·²ç» offload åˆ° CPU

### 3. è®­ç»ƒæ—¶é—´ä¼°ç®—
```
æ­¥æ•°      | æ—¶é—´
----------|------
2000      | ~1.5 å°æ—¶
5000      | ~4 å°æ—¶
10000     | ~8 å°æ—¶
25000     | ~18 å°æ—¶
41000     | ~30 å°æ—¶ (1 epoch)
```

---

## ğŸ¯ ä¸‹ä¸€æ­¥è¡ŒåŠ¨

### ç«‹å³æ‰§è¡Œ
1. **ç›‘æ§å½“å‰è®­ç»ƒ**
   ```bash
   bash scripts/monitor_training.sh
   ```

2. **ç­‰å¾… 2000 æ­¥å®Œæˆ**ï¼ˆçº¦ 1.5 å°æ—¶ï¼‰

3. **æµ‹è¯•ç¬¬ä¸€ä¸ª checkpoint**
   ```bash
   bash scripts/test_checkpoint.sh
   ```

### æ ¹æ®ç»“æœå†³å®š
- **å¦‚æœæ•ˆæœå¥½** â†’ ç»§ç»­è®­ç»ƒåˆ° 25000 æ­¥
- **å¦‚æœ Gate Collapse** â†’ æ·»åŠ  RMSNorm åé‡æ–°è®­ç»ƒ
- **å¦‚æœ Loss å¼‚å¸¸** â†’ æ£€æŸ¥æ—¥å¿—ï¼Œè°ƒæ•´å‚æ•°

---

## ğŸ“ é—®é¢˜æ’æŸ¥

### Loss å‡ºç° NaN
```bash
# æ£€æŸ¥æœ€è¿‘çš„æ—¥å¿—
tail -100 ./checkpoints/spatial_adapter_fp16_fixed/train.log | grep -i nan

# å¦‚æœå‡ºç° NaNï¼Œæ£€æŸ¥ dtype é…ç½®
grep "dtype" scripts/train_spatial_adapter.py | grep -E "float16|float32"
```

### è®­ç»ƒé€Ÿåº¦æ…¢
```bash
# æ£€æŸ¥ GPU åˆ©ç”¨ç‡
nvidia-smi

# å¦‚æœåˆ©ç”¨ç‡ä½ï¼Œå¯èƒ½æ˜¯æ•°æ®åŠ è½½ç“¶é¢ˆ
# è€ƒè™‘å¢åŠ  num_workersï¼ˆéœ€è¦ä¿®æ”¹è®­ç»ƒè„šæœ¬ï¼‰
```

### Checkpoint åŠ è½½å¤±è´¥
```bash
# æ£€æŸ¥ checkpoint æ–‡ä»¶
ls -lh ./checkpoints/spatial_adapter_fp16_fixed/*.pt

# æ‰‹åŠ¨æµ‹è¯•åŠ è½½
python -c "import torch; print(torch.load('checkpoint-2000.pt', map_location='cpu').keys())"
```

---

## ğŸ“š å‚è€ƒæ–‡æ¡£

- [Zero Init ä¿®å¤æŠ¥å‘Š](./zero_init_fix_report.md)
- [è®­ç»ƒæŒ‡å—](./TRAINING_GUIDE.md)
- [Gate Collapse åˆ†æ](./gate_collapse_analysis.md)

---

**æœ€åæ›´æ–°**: 2026-01-21
**çŠ¶æ€**: è®­ç»ƒè¿›è¡Œä¸­ âœ…

